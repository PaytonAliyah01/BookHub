@page "/Reading/Goals"
@model BookHub.Presentation.Pages.ReadingGoalsModel
@{
    ViewData["Title"] = "My Reading Goals";
}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-target"></i> My Reading Goals</h2>
            <p class="text-muted">Track your yearly reading progress and stay motivated!</p>
        </div>
    </div>
    @if (Model.CurrentGoal != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">@DateTime.Now.Year Reading Goal Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h3>@Model.CurrentGoal.BooksRead / @Model.CurrentGoal.TargetBooks books</h3>
                                <div class="progress mb-3" style="height: 30px;">
                                    <div class="progress-bar @(Model.CurrentGoal.IsCompleted ? "bg-success" : "bg-info")" 
                                         role="progressbar" 
                                         style="width: @Math.Min(100, Model.CurrentGoal.ProgressPercentage)%"
                                         aria-valuenow="@Model.CurrentGoal.ProgressPercentage" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        @Math.Round(Model.CurrentGoal.ProgressPercentage, 1)%
                                    </div>
                                </div>
                                @if ((bool)Model.ProgressAnalytics["IsCurrentYear"])
                                {
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <h6 class="text-muted mb-1">Year Progress</h6>
                                                <div class="progress mb-2" style="height: 20px;">
                                                    <div class="progress-bar bg-secondary" 
                                                         style="width: @Model.ProgressAnalytics["YearProgress"]%">
                                                        @Model.ProgressAnalytics["YearProgress"]%
                                                    </div>
                                                </div>
                                                <small class="text-muted">@Model.ProgressAnalytics["DaysPassed"] days passed</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h6 class="text-muted mb-1">Expected vs Actual</h6>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <span class="badge @((bool)Model.ProgressAnalytics["IsAhead"] ? "bg-success" : "bg-warning") me-2">
                                                    @((bool)Model.ProgressAnalytics["IsAhead"] ? "+" + Model.ProgressAnalytics["ProgressDifference"] : Model.ProgressAnalytics["ProgressDifference"]) books
                                                </span>
                                            </div>
                                            <small class="text-muted">Expected: @Model.ProgressAnalytics["ExpectedBooks"]</small>
                                        </div>
                                    </div>
                                }
                                <span class="badge @GetStatusBadgeClass(Model.CurrentGoal.ProgressStatus) badge-lg">
                                    @Model.CurrentGoal.ProgressStatus
                                </span>
                            </div>
                            <div class="col-md-4">
                                <div class="btn-group mb-3" role="group" style="width: 100%;">
                                    <form method="post" asp-page-handler="IncrementProgress" style="display:inline;">
                                        <input type="hidden" name="year" value="@DateTime.Now.Year" />
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Book Read
                                        </button>
                                    </form>
                                    @if (Model.CurrentGoal.BooksRead > 0)
                                    {
                                        <form method="post" asp-page-handler="DecrementProgress" style="display:inline;">
                                            <input type="hidden" name="year" value="@DateTime.Now.Year" />
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-minus"></i> Undo
                                            </button>
                                        </form>
                                    }
                                </div>
                                <p class="mt-3">@Model.MotivationalMessage</p>
                            </div>
                        </div>
                        @if (Model.ProgressAnalytics.ContainsKey("HasGoal") && (bool)Model.ProgressAnalytics["HasGoal"] && Model.ProgressAnalytics.ContainsKey("IsCurrentYear") && (bool)Model.ProgressAnalytics["IsCurrentYear"])
                        {
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted mb-3">ðŸ“Š Progress Analytics</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-info">@Model.ProgressAnalytics["CurrentPace"]</h5>
                                            <p class="card-text small text-muted mb-0">Projected books<br/>at current pace</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-warning">@Model.ProgressAnalytics["BooksNeededPerWeek"]</h5>
                                            <p class="card-text small text-muted mb-0">Books needed<br/>per week</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-primary">@Model.ProgressAnalytics["DailyTarget"]</h5>
                                            <p class="card-text small text-muted mb-0">Daily target<br/>(books/day)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-success">@Model.ProgressAnalytics["DaysRemaining"]</h5>
                                            <p class="card-text small text-muted mb-0">Days remaining<br/>in year</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    @if (Model.CurrentGoal != null && Model.CompletedBooksCurrentYear.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-check-circle"></i> Books Completed This Year (@DateTime.Now.Year)</h5>
                            <small>@Model.CompletedBooksCurrentYear.Count books contributing to your @DateTime.Now.Year goal</small>
                        </div>
                        <span class="badge badge-light fs-6">@Model.CompletedBooksCurrentYear.Count / @Model.CurrentGoal.TargetBooks</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var completedBook in Model.CompletedBooksCurrentYear.Take(12))
                            {
                                <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                                    <div class="card h-100 border-success">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <small class="text-success fw-bold">
                                                    <i class="fas fa-calendar-check"></i> 
                                                    @completedBook.DateAdded.ToString("MMM dd")
                                                </small>
                                                @if (completedBook.Rating.HasValue)
                                                {
                                                    <div class="text-warning">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <i class="fas fa-star@(i <= completedBook.Rating.Value ? "" : " text-muted")"></i>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            @if (completedBook.Book != null)
                                            {
                                                <h6 class="card-title mb-2" title="@completedBook.Book.Title">
                                                    @(completedBook.Book.Title.Length > 40 ? completedBook.Book.Title.Substring(0, 40) + "..." : completedBook.Book.Title)
                                                </h6>
                                                <p class="card-text text-muted small mb-1">
                                                    by @completedBook.Book.Author
                                                </p>
                                                @if (!string.IsNullOrEmpty(completedBook.Book.Genre))
                                                {
                                                    <span class="badge bg-secondary mb-2">@completedBook.Book.Genre</span>
                                                }
                                            }
                                            else
                                            {
                                                <h6 class="card-title mb-2">Book Details Not Available</h6>
                                            }
                                            @if (!string.IsNullOrEmpty(completedBook.Notes))
                                            {
                                                <p class="card-text small text-muted mb-0" title="@completedBook.Notes">
                                                    <i class="fas fa-sticky-note"></i> 
                                                    @(completedBook.Notes.Length > 50 ? completedBook.Notes.Substring(0, 50) + "..." : completedBook.Notes)
                                                </p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        @if (Model.CompletedBooksCurrentYear.Count > 12)
                        {
                            <div class="text-center mt-3">
                                <button class="btn btn-outline-success" onclick="toggleAllBooks()">
                                    <span id="toggleBooksText">View All @Model.CompletedBooksCurrentYear.Count Books</span>
                                    <i id="toggleBooksIcon" class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <div id="allBooksContainer" style="display: none;" class="mt-3">
                                <div class="row">
                                    @foreach (var completedBook in Model.CompletedBooksCurrentYear.Skip(12))
                                    {
                                        <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                                            <div class="card h-100 border-success">
                                                <div class="card-body p-3">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <small class="text-success fw-bold">
                                                            <i class="fas fa-calendar-check"></i> 
                                                            @completedBook.DateAdded.ToString("MMM dd")
                                                        </small>
                                                        @if (completedBook.Rating.HasValue)
                                                        {
                                                            <div class="text-warning">
                                                                @for (int i = 1; i <= 5; i++)
                                                                {
                                                                    <i class="fas fa-star@(i <= completedBook.Rating.Value ? "" : " text-muted")"></i>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                    @if (completedBook.Book != null)
                                                    {
                                                        <h6 class="card-title mb-2" title="@completedBook.Book.Title">
                                                            @(completedBook.Book.Title.Length > 40 ? completedBook.Book.Title.Substring(0, 40) + "..." : completedBook.Book.Title)
                                                        </h6>
                                                        <p class="card-text text-muted small mb-1">
                                                            by @completedBook.Book.Author
                                                        </p>
                                                        @if (!string.IsNullOrEmpty(completedBook.Book.Genre))
                                                        {
                                                            <span class="badge bg-secondary mb-2">@completedBook.Book.Genre</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <h6 class="card-title mb-2">Book Details Not Available</h6>
                                                    }
                                                    @if (!string.IsNullOrEmpty(completedBook.Notes))
                                                    {
                                                        <p class="card-text small text-muted mb-0" title="@completedBook.Notes">
                                                            <i class="fas fa-sticky-note"></i> 
                                                            @(completedBook.Notes.Length > 50 ? completedBook.Notes.Substring(0, 50) + "..." : completedBook.Notes)
                                                        </p>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        @if (!Model.CompletedBooksCurrentYear.Any())
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No books completed yet this year</h5>
                                <p class="text-muted">Start reading to see your progress toward your @DateTime.Now.Year goal!</p>
                                <a href="/Books/Books" class="btn btn-primary">Browse Books</a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    @if (Model.CurrentUser != null && Model.ReadingProgressData.Any() && !Model.ReadingProgressData.ContainsKey("Error"))
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Reading Progress Analytics</h5>
                        <small>Visual insights into your reading journey</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h6 class="text-muted mb-3"><i class="fas fa-target"></i> Goals History</h6>
                                <canvas id="goalsHistoryChart" height="250"></canvas>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h6 class="text-muted mb-3"><i class="fas fa-calendar"></i> Monthly Progress (@DateTime.Now.Year)</h6>
                                <canvas id="monthlyProgressChart" height="250"></canvas>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h6 class="text-muted mb-3"><i class="fas fa-layer-group"></i> Genre Distribution</h6>
                                <canvas id="genreBreakdownChart" height="250"></canvas>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h6 class="text-muted mb-3"><i class="fas fa-list-check"></i> Reading Status</h6>
                                <canvas id="readingStatusChart" height="250"></canvas>
                            </div>
                        </div>
                        <div class="row mt-3">
                            @if (Model.BookshelfAnalytics.ContainsKey("TotalBooks"))
                            {
                                <div class="col-md-2 text-center">
                                    <div class="border-end">
                                        <h4 class="text-primary mb-1">@Model.BookshelfAnalytics["TotalBooks"]</h4>
                                        <small class="text-muted">Total Books</small>
                                    </div>
                                </div>
                            }
                            @if (Model.ReadingProgressData.ContainsKey("ReadingStats"))
                            {
                                var stats = (Dictionary<string, object>)Model.ReadingProgressData["ReadingStats"];
                                <div class="col-md-2 text-center">
                                    <div class="border-end">
                                        <h4 class="text-success mb-1">@stats["TotalBooksRead"]</h4>
                                        <small class="text-muted">Books Read</small>
                                    </div>
                                </div>
                                <div class="col-md-2 text-center">
                                    <div class="border-end">
                                        <h4 class="text-info mb-1">@stats["CurrentReadingStreak"]</h4>
                                        <small class="text-muted">Reading Streak</small>
                                    </div>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="border-end">
                                        <h4 class="text-warning mb-1">@stats["FavoriteGenre"]</h4>
                                        <small class="text-muted">Favorite Genre</small>
                                    </div>
                                </div>
                            }
                            <div class="col-md-3 text-center">
                                <a href="/Reading/Analytics" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-chart-bar"></i> View Full Analytics
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script id="goals-analytics-data" type="application/json">
            {
                "readingGoalsHistory": @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReadingProgressData.ContainsKey("ReadingGoalsHistory") ? Model.ReadingProgressData["ReadingGoalsHistory"] : new object[]{})),
                "monthlyProgress": @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReadingProgressData.ContainsKey("MonthlyProgress") ? Model.ReadingProgressData["MonthlyProgress"] : new object[]{})),
                "genreBreakdown": @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReadingProgressData.ContainsKey("GenreBreakdown") ? Model.ReadingProgressData["GenreBreakdown"] : new Dictionary<string, int>())),
                "statusBreakdown": @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BookshelfAnalytics.ContainsKey("StatusBreakdown") ? Model.BookshelfAnalytics["StatusBreakdown"] : new Dictionary<string, int>()))
            }
        </script>
    }
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Set New Goal</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Message))
                    {
                        <div class="alert @(Model.Message.Contains("Success") || Model.Message.Contains("Congratulations") ? "alert-success" : "alert-danger") alert-dismissible fade show">
                            @Model.Message
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    <form method="post" asp-page-handler="SetGoal">
                        <div class="mb-3">
                            <label for="year" class="form-label">Year</label>
                            <select id="year" name="year" class="form-select" required>
                                <option value="">Select Year</option>
                                @foreach (var year in Model.AvailableYears)
                                {
                                    @if (year == DateTime.Now.Year)
                                    {
                                        <option value="@year" selected>@year</option>
                                    }
                                    else
                                    {
                                        <option value="@year">@year</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="targetBooks" class="form-label">Target Books</label>
                            <input type="number" id="targetBooks" name="targetBooks" class="form-control" 
                                   min="1" max="1000" required placeholder="e.g., 20">
                            <div class="form-text">How many books do you want to read this year?</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Set Goal
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Edit Existing Goal</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="EditGoal">
                        <div class="mb-3">
                            <label for="editYear" class="form-label">Year</label>
                            <select id="editYear" name="year" class="form-select" required onchange="updateCurrentTarget(this.value)">
                                <option value="">Select Year</option>
                                @if (Model.AllGoals.Any())
                                {
                                    @foreach (var goal in Model.AllGoals)
                                    {
                                        <option value="@goal.Year" data-target="@goal.TargetBooks">@goal.Year (Current: @goal.TargetBooks books)</option>
                                    }
                                }
                                else
                                {
                                    <option disabled>No goals set yet</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newTargetBooks" class="form-label">New Target Books</label>
                            <input type="number" id="newTargetBooks" name="newTargetBooks" class="form-control" 
                                   min="1" max="1000" required placeholder="Enter new target">
                            <div class="form-text">Update the target for this reading goal</div>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Update Goal
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Update Progress</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="UpdateProgress">
                        <div class="mb-3">
                            <label for="progressYear" class="form-label">Year</label>
                            <select id="progressYear" name="year" class="form-select" required>
                                <option value="">Select Year</option>
                                @if (Model.AllGoals.Any())
                                {
                                    @foreach (var goal in Model.AllGoals)
                                    {
                                        <option value="@goal.Year">@goal.Year</option>
                                    }
                                }
                                else
                                {
                                    <option disabled>No goals set yet</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="booksRead" class="form-label">Books Read</label>
                            <input type="number" id="booksRead" name="booksRead" class="form-control" 
                                   min="0" max="1000" required>
                            <div class="form-text">Update your total books read for the year</div>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-edit"></i> Update Progress
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @if (Model.CompletedBooksByYear.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Completed Books by Year</h5>
                        <small class="text-muted">View books that contributed to your reading goals across all years</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var yearGroup in Model.CompletedBooksByYear.OrderByDescending(kvp => kvp.Key))
                            {
                                var year = yearGroup.Key;
                                var books = yearGroup.Value;
                                var yearGoal = Model.AllGoals.FirstOrDefault(g => g.Year == year);
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card border-info h-100">
                                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">@year</h6>
                                            <div>
                                                @if (yearGoal != null)
                                                {
                                                    <span class="badge badge-light">@books.Count / @yearGoal.TargetBooks</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-light">@books.Count books</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                                            @foreach (var book in books.Take(10))
                                            {
                                                <div class="border-bottom pb-2 mb-2">
                                                    @if (book.Book != null)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-1 small" title="@book.Book.Title">
                                                                    @(book.Book.Title.Length > 30 ? book.Book.Title.Substring(0, 30) + "..." : book.Book.Title)
                                                                </h6>
                                                                <p class="mb-1 text-muted" style="font-size: 0.8em;">@book.Book.Author</p>
                                                            </div>
                                                            <div class="text-end ms-2">
                                                                <small class="text-muted">@book.DateAdded.ToString("MMM dd")</small>
                                                                @if (book.Rating.HasValue)
                                                                {
                                                                    <div class="text-warning" style="font-size: 0.8em;">
                                                                        @for (int i = 1; i <= book.Rating.Value; i++)
                                                                        {
                                                                            <i class="fas fa-star"></i>
                                                                        }
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <h6 class="mb-1 small text-muted">Book details not available</h6>
                                                        <small class="text-muted">@book.DateAdded.ToString("MMM dd")</small>
                                                    }
                                                </div>
                                            }
                                            @if (books.Count > 10)
                                            {
                                                <div class="text-center">
                                                    <button class="btn btn-outline-info btn-sm" onclick="viewYearBooks(@year)">
                                                        View All @books.Count Books
                                                    </button>
                                                </div>
                                            }
                                            @if (yearGoal != null)
                                            {
                                                <div class="mt-2 pt-2 border-top">
                                                    <div class="progress" style="height: 15px;">
                                                        <div class="progress-bar @(yearGoal.IsCompleted ? "bg-success" : "bg-info")" 
                                                             style="width: @Math.Min(100, yearGoal.ProgressPercentage)%">
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">@Math.Round(yearGoal.ProgressPercentage, 1)% of @year goal</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    @if (Model.AllGoals.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Reading Goals</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Target</th>
                                        <th>Books Read</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var goal in Model.AllGoals)
                                    {
                                        <tr>
                                            <td>@goal.Year</td>
                                            <td>@goal.TargetBooks</td>
                                            <td>@goal.BooksRead</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar @(goal.IsCompleted ? "bg-success" : "bg-info")" 
                                                         style="width: @Math.Min(100, goal.ProgressPercentage)%">
                                                        @Math.Round(goal.ProgressPercentage, 1)%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(goal.ProgressStatus)">
                                                    @goal.ProgressStatus
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-warning btn-sm" 
                                                            onclick="editGoal(@goal.Year, @goal.TargetBooks)"
                                                            title="Edit Goal">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <form method="post" asp-page-handler="DeleteGoal" style="display:inline;">
                                                        <input type="hidden" name="goalId" value="@goal.ReadingGoalId" />
                                                        <button type="submit" class="btn btn-danger btn-sm" 
                                                                onclick="return confirm('Are you sure you want to delete this goal?')"
                                                                title="Delete Goal">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataElement = document.getElementById('goals-analytics-data');
    if (!dataElement) return;
    const data = JSON.parse(dataElement.textContent);
    if (data.readingGoalsHistory && data.readingGoalsHistory.length > 0) {
        const ctx1 = document.getElementById('goalsHistoryChart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: data.readingGoalsHistory.map(d => d.year),
                datasets: [{
                    label: 'Target Books',
                    data: data.readingGoalsHistory.map(d => d.target),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'Books Read',
                    data: data.readingGoalsHistory.map(d => d.actual),
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Reading Goals vs Achievement'
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Books'
                        }
                    }
                }
            }
        });
    }
    if (data.monthlyProgress && data.monthlyProgress.length > 0) {
        const ctx2 = document.getElementById('monthlyProgressChart').getContext('2d');
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: data.monthlyProgress.map(d => d.month),
                datasets: [{
                    label: 'Books Read',
                    data: data.monthlyProgress.map(d => d.books),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Reading Progress'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Books Read'
                        }
                    }
                }
            }
        });
    }
    if (data.genreBreakdown && Object.keys(data.genreBreakdown).length > 0) {
        const genreLabels = Object.keys(data.genreBreakdown);
        const genreValues = Object.values(data.genreBreakdown);
        const ctx3 = document.getElementById('genreBreakdownChart').getContext('2d');
        new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: genreLabels,
                datasets: [{
                    data: genreValues,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Favorite Genres'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    if (data.statusBreakdown && Object.keys(data.statusBreakdown).length > 0) {
        const statusLabels = Object.keys(data.statusBreakdown);
        const statusValues = Object.values(data.statusBreakdown);
        const ctx4 = document.getElementById('readingStatusChart').getContext('2d');
        new Chart(ctx4, {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: [
                        '#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Reading Status Overview'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
});
function updateCurrentTarget(selectedYear) {
    const selectElement = document.getElementById('editYear');
    const targetInput = document.getElementById('newTargetBooks');
    if (selectedYear) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const currentTarget = selectedOption.getAttribute('data-target');
        if (currentTarget) {
            targetInput.placeholder = `Current: ${currentTarget} books`;
            targetInput.value = currentTarget;
        }
    } else {
        targetInput.placeholder = 'Enter new target';
        targetInput.value = '';
    }
}
function editGoal(year, currentTarget) {
    const yearSelect = document.getElementById('editYear');
    const targetInput = document.getElementById('newTargetBooks');
    yearSelect.value = year;
    targetInput.value = currentTarget;
    targetInput.placeholder = `Current: ${currentTarget} books`;
    yearSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const editCard = yearSelect.closest('.card');
    editCard.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.5)';
    setTimeout(() => {
        editCard.style.boxShadow = '';
    }, 2000);
}
function toggleAllBooks() {
    const container = document.getElementById('allBooksContainer');
    const toggleText = document.getElementById('toggleBooksText');
    const toggleIcon = document.getElementById('toggleBooksIcon');
    if (container.style.display === 'none') {
        container.style.display = 'block';
        toggleText.textContent = 'Show Less';
        toggleIcon.className = 'fas fa-chevron-up';
    } else {
        container.style.display = 'none';
        toggleText.textContent = 'View All Books';
        toggleIcon.className = 'fas fa-chevron-down';
    }
}
function viewYearBooks(year) {
    alert(`Detailed view for ${year} books coming soon! For now, scroll down to see all books in the year cards.`);
}
</script>
<style>
.chart-container {
    position: relative;
    height: 250px;
}
.border-end {
    border-right: 1px solid #dee2e6;
}
.card .card-body canvas {
    max-height: 250px;
}
</style>
@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Completed" => "badge-success",
            "On Track" => "badge-primary",
            "Behind" => "badge-warning",
            "Far Behind" => "badge-danger",
            _ => "badge-secondary"
        };
    }
}
