@page
@model BookHub.Presentation.Pages.ReadingGoalsModel
@{
    ViewData["Title"] = "My Reading Goals";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-target"></i> My Reading Goals</h2>
            <p class="text-muted">Track your yearly reading progress and stay motivated!</p>
        </div>
    </div>

    @if (Model.CurrentGoal != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">@DateTime.Now.Year Reading Goal Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h3>@Model.CurrentGoal.BooksRead / @Model.CurrentGoal.TargetBooks books</h3>
                                <div class="progress mb-3" style="height: 30px;">
                                    <div class="progress-bar @(Model.CurrentGoal.IsCompleted ? "bg-success" : "bg-info")" 
                                         role="progressbar" 
                                         style="width: @Math.Min(100, Model.CurrentGoal.ProgressPercentage)%"
                                         aria-valuenow="@Model.CurrentGoal.ProgressPercentage" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        @Math.Round(Model.CurrentGoal.ProgressPercentage, 1)%
                                    </div>
                                </div>
                                
                                @if ((bool)Model.ProgressAnalytics["IsCurrentYear"])
                                {
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <div class="border-end">
                                                <h6 class="text-muted mb-1">Year Progress</h6>
                                                <div class="progress mb-2" style="height: 20px;">
                                                    <div class="progress-bar bg-secondary" 
                                                         style="width: @Model.ProgressAnalytics["YearProgress"]%">
                                                        @Model.ProgressAnalytics["YearProgress"]%
                                                    </div>
                                                </div>
                                                <small class="text-muted">@Model.ProgressAnalytics["DaysPassed"] days passed</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h6 class="text-muted mb-1">Expected vs Actual</h6>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <span class="badge @((bool)Model.ProgressAnalytics["IsAhead"] ? "bg-success" : "bg-warning") me-2">
                                                    @((bool)Model.ProgressAnalytics["IsAhead"] ? "+" + Model.ProgressAnalytics["ProgressDifference"] : Model.ProgressAnalytics["ProgressDifference"]) books
                                                </span>
                                            </div>
                                            <small class="text-muted">Expected: @Model.ProgressAnalytics["ExpectedBooks"]</small>
                                        </div>
                                    </div>
                                }
                                
                                <span class="badge @GetStatusBadgeClass(Model.CurrentGoal.ProgressStatus) badge-lg">
                                    @Model.CurrentGoal.ProgressStatus
                                </span>
                            </div>
                            <div class="col-md-4">
                                <div class="btn-group mb-3" role="group" style="width: 100%;">
                                    <form method="post" asp-page-handler="IncrementProgress" style="display:inline;">
                                        <input type="hidden" name="year" value="@DateTime.Now.Year" />
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Book Read
                                        </button>
                                    </form>
                                    @if (Model.CurrentGoal.BooksRead > 0)
                                    {
                                        <form method="post" asp-page-handler="DecrementProgress" style="display:inline;">
                                            <input type="hidden" name="year" value="@DateTime.Now.Year" />
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-minus"></i> Undo
                                            </button>
                                        </form>
                                    }
                                </div>
                                <p class="mt-3">@Model.MotivationalMessage</p>
                            </div>
                        </div>

                        @if (Model.ProgressAnalytics.ContainsKey("HasGoal") && (bool)Model.ProgressAnalytics["HasGoal"] && Model.ProgressAnalytics.ContainsKey("IsCurrentYear") && (bool)Model.ProgressAnalytics["IsCurrentYear"])
                        {
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted mb-3">ðŸ“Š Progress Analytics</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-info">@Model.ProgressAnalytics["CurrentPace"]</h5>
                                            <p class="card-text small text-muted mb-0">Projected books<br/>at current pace</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-warning">@Model.ProgressAnalytics["BooksNeededPerWeek"]</h5>
                                            <p class="card-text small text-muted mb-0">Books needed<br/>per week</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-primary">@Model.ProgressAnalytics["DailyTarget"]</h5>
                                            <p class="card-text small text-muted mb-0">Daily target<br/>(books/day)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-3">
                                            <h5 class="card-title text-success">@Model.ProgressAnalytics["DaysRemaining"]</h5>
                                            <p class="card-text small text-muted mb-0">Days remaining<br/>in year</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Set Reading Goal</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Message))
                    {
                        <div class="alert @(Model.Message.Contains("Success") || Model.Message.Contains("Congratulations") ? "alert-success" : "alert-danger") alert-dismissible fade show">
                            @Model.Message
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    <form method="post" asp-page-handler="SetGoal">
                        <div class="mb-3">
                            <label for="year" class="form-label">Year</label>
                            <select id="year" name="year" class="form-select" required>
                                <option value="">Select Year</option>
                                @foreach (var year in Model.AvailableYears)
                                {
                                    @if (year == DateTime.Now.Year)
                                    {
                                        <option value="@year" selected>@year</option>
                                    }
                                    else
                                    {
                                        <option value="@year">@year</option>
                                    }
                                }
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="targetBooks" class="form-label">Target Books</label>
                            <input type="number" id="targetBooks" name="targetBooks" class="form-control" 
                                   min="1" max="1000" required placeholder="e.g., 20">
                            <div class="form-text">How many books do you want to read this year?</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Set Goal
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Update Progress</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="UpdateProgress">
                        <div class="mb-3">
                            <label for="progressYear" class="form-label">Year</label>
                            <select id="progressYear" name="year" class="form-select" required>
                                <option value="">Select Year</option>
                                @if (Model.AllGoals.Any())
                                {
                                    @foreach (var goal in Model.AllGoals)
                                    {
                                        <option value="@goal.Year">@goal.Year</option>
                                    }
                                }
                                else
                                {
                                    <option disabled>No goals set yet</option>
                                }
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="booksRead" class="form-label">Books Read</label>
                            <input type="number" id="booksRead" name="booksRead" class="form-control" 
                                   min="0" max="1000" required>
                            <div class="form-text">Update your total books read for the year</div>
                        </div>
                        
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-edit"></i> Update Progress
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @if (Model.AllGoals.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Reading Goals</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Target</th>
                                        <th>Books Read</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var goal in Model.AllGoals)
                                    {
                                        <tr>
                                            <td>@goal.Year</td>
                                            <td>@goal.TargetBooks</td>
                                            <td>@goal.BooksRead</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar @(goal.IsCompleted ? "bg-success" : "bg-info")" 
                                                         style="width: @Math.Min(100, goal.ProgressPercentage)%">
                                                        @Math.Round(goal.ProgressPercentage, 1)%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(goal.ProgressStatus)">
                                                    @goal.ProgressStatus
                                                </span>
                                            </td>
                                            <td>
                                                <form method="post" asp-page-handler="DeleteGoal" style="display:inline;">
                                                    <input type="hidden" name="goalId" value="@goal.ReadingGoalId" />
                                                    <button type="submit" class="btn btn-danger btn-sm" 
                                                            onclick="return confirm('Are you sure you want to delete this goal?')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Completed" => "badge-success",
            "On Track" => "badge-primary",
            "Behind" => "badge-warning",
            "Far Behind" => "badge-danger",
            _ => "badge-secondary"
        };
    }
}