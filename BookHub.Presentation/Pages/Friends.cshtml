@page
@model BookHub.Presentation.Pages.FriendsModel
@{
    ViewData["Title"] = "Friends";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-users me-2"></i>Friends
            </h2>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="friendsTabs">
                <li class="nav-item">
                    <a class="nav-link @(Model.CurrentTab == "friends" ? "active" : "")" 
                       href="?tab=friends">
                        <i class="fas fa-user-friends me-1"></i>My Friends (@Model.Friends.Count)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(Model.CurrentTab == "requests" ? "active" : "")" 
                       href="?tab=requests">
                        <i class="fas fa-user-plus me-1"></i>Friend Requests 
                        @if (Model.PendingRequests.Count > 0)
                        {
                            <span class="badge bg-danger">@Model.PendingRequests.Count</span>
                        }
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(Model.CurrentTab == "search" ? "active" : "")" 
                       href="?tab=search">
                        <i class="fas fa-search me-1"></i>Find Friends
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(Model.CurrentTab == "activity" ? "active" : "")" 
                       href="?tab=activity">
                        <i class="fas fa-book-reader me-1"></i>Friends' Activity
                    </a>
                </li>
            </ul>

            <!-- Error Messages -->
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        
        <!-- My Friends Tab -->
        @if (Model.CurrentTab == "friends")
        {
            <div class="tab-pane fade show active">
                @if (Model.Friends.Any())
                {
                    <div class="row">
                        @foreach (var friend in Model.Friends)
                        {
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card friend-card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <img src="~/images/profiles/@friend.ProfileImage" 
                                                 alt="@friend.Name" 
                                                 class="rounded-circle me-3" 
                                                 style="width: 60px; height: 60px; object-fit: cover;"
                                                 onerror="this.src='/images/profiles/default.png'">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">@friend.Name</h6>
                                                <p class="text-muted small mb-2">@friend.Email</p>
                                                @if (!string.IsNullOrEmpty(friend.Bio))
                                                {
                                                    <p class="small text-muted mb-0">@friend.Bio</p>
                                                }
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="removeFriend(@friend.UserId, '@friend.Name')">
                                                <i class="fas fa-user-minus me-1"></i>Remove Friend
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Friends Yet</h4>
                        <p class="text-muted">Use the "Find Friends" tab to search for users and send friend requests.</p>
                        <a href="?tab=search" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Find Friends
                        </a>
                    </div>
                }
            </div>
        }

        <!-- Friend Requests Tab -->
        @if (Model.CurrentTab == "requests")
        {
            <div class="tab-pane fade show active">
                @if (Model.PendingRequests.Any())
                {
                    <div class="row">
                        @foreach (var request in Model.PendingRequests)
                        {
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card request-card" id="request-@request.RequestId">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="~/images/profiles/@(request.FromUser?.ProfileImage ?? "default.png")" 
                                                 alt="@(request.FromUser?.Name ?? "Unknown User")" 
                                                 class="rounded-circle me-3" 
                                                 style="width: 50px; height: 50px; object-fit: cover;"
                                                 onerror="this.src='/images/profiles/default.png'">
                                            <div>
                                                <h6 class="card-title mb-1">@(request.FromUser?.Name ?? "Unknown User")</h6>
                                                <p class="text-muted small mb-0">@(request.FromUser?.Email ?? "")</p>
                                                <small class="text-muted">@request.RequestDate.ToString("MMM dd, yyyy")</small>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(request.FromUser?.Bio))
                                        {
                                            <p class="small text-muted mb-3">@request.FromUser.Bio</p>
                                        }
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success btn-sm flex-fill" 
                                                    onclick="respondToRequest(@request.RequestId, 'accept')">
                                                <i class="fas fa-check me-1"></i>Accept
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm flex-fill" 
                                                    onclick="respondToRequest(@request.RequestId, 'decline')">
                                                <i class="fas fa-times me-1"></i>Decline
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Pending Requests</h4>
                        <p class="text-muted">You have no pending friend requests at the moment.</p>
                    </div>
                }
            </div>
        }

        <!-- Find Friends Tab -->
        @if (Model.CurrentTab == "search")
        {
            <div class="tab-pane fade show active">
                <!-- Search Form -->
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8">
                        <form method="post" asp-page-handler="Search" class="search-form">
                            <div class="input-group">
                                <input type="text" class="form-control" asp-for="SearchTerm" 
                                       placeholder="Search by name or email..." 
                                       value="@Model.SearchTerm">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Search Results -->
                @if (Model.SearchResults.Any())
                {
                    <div class="row">
                        @foreach (var user in Model.SearchResults)
                        {
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card user-card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="~/images/profiles/@user.ProfileImage" 
                                                 alt="@user.Name" 
                                                 class="rounded-circle me-3" 
                                                 style="width: 50px; height: 50px; object-fit: cover;"
                                                 onerror="this.src='/images/profiles/default.png'">
                                            <div>
                                                <h6 class="card-title mb-1">@user.Name</h6>
                                                <p class="text-muted small mb-0">@user.Email</p>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(user.Bio))
                                        {
                                            <p class="small text-muted mb-3">@user.Bio</p>
                                        }
                                        
                                        @{
                                            var relationshipStatus = Model.UserRelationships.GetValueOrDefault(user.UserId, "NotFriends");
                                        }
                                        
                                        <div class="relationship-actions">
                                            @switch (relationshipStatus)
                                            {
                                                case "Friends":
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-user-check me-1"></i>Friends
                                                    </span>
                                                    break;
                                                case "RequestPending":
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Request Sent
                                                    </span>
                                                    break;
                                                case "RequestReceived":
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-inbox me-1"></i>Sent You Request
                                                    </span>
                                                    break;
                                                default:
                                                    <button class="btn btn-outline-primary btn-sm" 
                                                            onclick="sendFriendRequest(@user.UserId, '@user.Name')"
                                                            id="request-btn-@user.UserId">
                                                        <i class="fas fa-user-plus me-1"></i>Add Friend
                                                    </button>
                                                    break;
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(Model.SearchTerm))
                {
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Users Found</h4>
                        <p class="text-muted">No users match your search term "@Model.SearchTerm".</p>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Search for Friends</h4>
                        <p class="text-muted">Enter a name or email address to find users and send friend requests.</p>
                    </div>
                }
            </div>
        }

        <!-- Friends Activity Tab -->
        @if (Model.CurrentTab == "activity")
        {
            <div class="tab-pane fade show active">
                @if (Model.FriendsActivity.Any())
                {
                    <div class="activity-feed">
                        @foreach (var activity in Model.FriendsActivity)
                        {
                            <div class="card activity-card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <img src="~/images/profiles/@activity.ProfileImage" 
                                             alt="@activity.UserName" 
                                             class="rounded-circle me-3" 
                                             style="width: 40px; height: 40px; object-fit: cover;"
                                             onerror="this.src='/images/profiles/default.png'">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <strong>@activity.UserName</strong>
                                                <span class="ms-2">
                                                    @if (activity.ActivityType == "review")
                                                    {
                                                        <span class="text-primary">reviewed</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-success">added to shelf</span>
                                                    }
                                                </span>
                                                <small class="text-muted ms-auto">@((DateTime)activity.ActivityDate).ToString("MMM dd")</small>
                                            </div>
                                            
                                            <div class="d-flex">
                                                @if (!string.IsNullOrEmpty(activity.CoverImage))
                                                {
                                                    <img src="@activity.CoverImage" 
                                                         alt="@activity.BookTitle" 
                                                         class="book-cover-small me-3"
                                                         style="width: 50px; height: 70px; object-fit: cover;">
                                                }
                                                else
                                                {
                                                    <div class="generated-book-cover-small me-3" 
                                                         style="width: 50px; height: 70px;">
                                                        <div class="book-spine"></div>
                                                        <div class="book-title">@activity.BookTitle.Substring(0, Math.Min(3, activity.BookTitle.Length))</div>
                                                    </div>
                                                }
                                                
                                                <div>
                                                    <h6 class="mb-1">@activity.BookTitle</h6>
                                                    <small class="text-muted">by @activity.BookAuthor</small>
                                                    
                                                    @if (activity.ActivityType == "review" && activity.Rating != null)
                                                    {
                                                        <div class="mt-1">
                                                            @for (int i = 1; i <= 5; i++)
                                                            {
                                                                @if (i <= activity.Rating)
                                                                {
                                                                    <i class="fas fa-star text-warning"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="far fa-star text-muted"></i>
                                                                }
                                                            }
                                                        </div>
                                                        
                                                        @if (!string.IsNullOrEmpty(activity.ReviewText))
                                                        {
                                                            <p class="small mt-2 mb-0">@activity.ReviewText</p>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (Model.Friends.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Recent Activity</h4>
                        <p class="text-muted">Your friends haven't been active recently. Check back later!</p>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Add Friends to See Activity</h4>
                        <p class="text-muted">Once you have friends, you'll see their reading activity here.</p>
                        <a href="?tab=search" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Find Friends
                        </a>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Send friend request
        async function sendFriendRequest(toUserId, userName) {
            try {
                const formData = new FormData();
                formData.append('toUserId', toUserId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch('/Friends?handler=SendRequest', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    const btn = document.getElementById(`request-btn-${toUserId}`);
                    btn.outerHTML = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Request Sent</span>';
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'Error sending friend request. Please try again.');
            }
        }
        
        // Respond to friend request
        async function respondToRequest(requestId, action) {
            try {
                const formData = new FormData();
                formData.append('requestId', requestId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const handler = action === 'accept' ? 'AcceptRequest' : 'DeclineRequest';
                const response = await fetch(`/Friends?handler=${handler}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    document.getElementById(`request-${requestId}`).remove();
                    
                    // Update badge count
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'Error responding to request. Please try again.');
            }
        }
        
        // Remove friend
        async function removeFriend(friendUserId, friendName) {
            if (!confirm(`Are you sure you want to remove ${friendName} from your friends?`)) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('friendUserId', friendUserId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch('/Friends?handler=RemoveFriend', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'Error removing friend. Please try again.');
            }
        }
        
        // Show alert message
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
}

<style>
    .friend-card, .request-card, .user-card, .activity-card {
        transition: transform 0.2s ease;
        border: 1px solid #e9ecef;
    }
    
    .friend-card:hover, .request-card:hover, .user-card:hover, .activity-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .search-form .input-group {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 25px;
        overflow: hidden;
    }
    
    .search-form .form-control {
        border: none;
        padding: 12px 20px;
    }
    
    .search-form .btn {
        border: none;
        padding: 12px 25px;
    }
    
    .book-cover-small {
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .generated-book-cover-small {
        background: linear-gradient(45deg, #6c5ce7, #a29bfe);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8em;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .activity-feed {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        margin-right: 5px;
    }
    
    .badge {
        font-size: 0.75em;
    }
</style>