@page
@model BookHub.Presentation.Pages.Community.BookClubDetailsModel
@{
    ViewData["Title"] = Model.Club?.Name ?? "Book Club";
}

<div class="container my-5">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Community/BookClubs">Book Clubs</a></li>
            <li class="breadcrumb-item active" aria-current="page">@(Model.Club?.Name ?? "Details")</li>
        </ol>
    </nav>
    
    @if (Model.Club == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Book club not found.
        </div>
        <a href="/Community/BookClubs" class="btn btn-primary">
            <i class="bi bi-arrow-left me-2"></i>Back to Book Clubs
        </a>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h1 class="card-title mb-2">@Model.Club.Name</h1>
                                @if (!string.IsNullOrEmpty(Model.Club.Genre))
                                {
                                    <span class="badge bg-primary">@Model.Club.Genre</span>
                                }
                            </div>
                            @if (Model.IsOwner)
                            {
                                <span class="badge bg-warning text-dark fs-6">
                                    <i class="bi bi-crown me-1"></i>Owner
                                </span>
                            }
                        </div>
                        
                        <p class="lead text-muted mb-4">@Model.Club.Description</p>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-people text-primary fs-4 me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Members</small>
                                        <strong>@Model.MemberCount / @Model.Club.MaxMembers</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar text-info fs-4 me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Created</small>
                                        <strong>@Model.Club.CreatedDate.ToString("MMM dd, yyyy")</strong>
                                    </div>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(Model.Club.MeetingSchedule))
                            {
                                <div class="col-md-12">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-clock text-success fs-4 me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">Meeting Schedule</small>
                                            <strong>@Model.Club.MeetingSchedule</strong>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        @if (Model.Club.MaxMembers <= Model.MemberCount)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                This book club is currently at full capacity.
                            </div>
                        }

                        @if (Model.IsOwner)
                        {
                            <div class="mb-3">
                                <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#editClubModal">
                                    <i class="bi bi-pencil me-1"></i>Edit Club
                                </button>
                                <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#setBookModal">
                                    <i class="bi bi-book me-1"></i>Set Current Book
                                </button>
                                <a href="/Community/Forum?clubId=@Model.Club.ClubId" class="btn btn-info me-2">
                                    <i class="bi bi-chat-dots me-1"></i>Manage Forum
                                </a>
                                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteClubModal">
                                    <i class="bi bi-trash me-1"></i>Delete Club
                                </button>
                            </div>
                            
                            @if (Model.PendingMembers.Any())
                            {
                                <div class="alert alert-info">
                                    <i class="bi bi-people me-2"></i>
                                    <strong>@Model.PendingMembers.Count</strong> member request(s) pending approval
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#pendingMembersModal">
                                        Review
                                    </button>
                                </div>
                            }
                        }

                        @if (!Model.IsMember)
                        {
                            @if (Model.Club.MaxMembers <= Model.MemberCount)
                            {
                                <button class="btn btn-secondary btn-lg" disabled>
                                    <i class="bi bi-x-circle me-2"></i>Club Full
                                </button>
                            }
                            else
                            {
                                <form method="post" asp-page-handler="JoinClub">
                                    <input type="hidden" name="clubId" value="@Model.Club.ClubId" />
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-plus-circle me-2"></i>Join Book Club
                                    </button>
                                </form>
                            }
                        }
                        else
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                You are a member of this book club
                            </div>
                            @if (!Model.IsOwner)
                            {
                                <form method="post" asp-page-handler="LeaveClub">
                                    <input type="hidden" name="clubId" value="@Model.Club.ClubId" />
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="bi bi-box-arrow-right me-2"></i>Leave Book Club
                                    </button>
                                </form>
                            }
                        }
                    </div>
                </div>

                @if (Model.IsMember)
                {
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Discussions</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDiscussionModal">
                                    <i class="bi bi-plus-circle me-2"></i>Start a Discussion
                                </button>
                            </div>
                        
                        
                        @if (Model.Discussions.Any())
                        {
                            <div class="list-group">
                                @foreach (var discussion in Model.Discussions)
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">@discussion.Title</h6>
                                            <small>@discussion.CreatedDate.ToString("MMM dd")</small>
                                        </div>
                                        <p class="mb-1">@discussion.Content</p>
                                        <small class="text-muted">By @@@(discussion.User?.Username ?? $"User {discussion.UserId}")</small>
                                    </div>
                                }
                            </div>
                            }
                            else
                            {
                                <p class="text-muted text-center py-4">No discussions yet. Start one!</p>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-lock fs-1 text-muted mb-3"></i>
                            <h5 class="mb-3">Members Only</h5>
                            <p class="text-muted">Join this book club to participate in discussions and connect with other members.</p>
                        </div>
                    </div>
                }
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-people me-2"></i>Members (@Model.MemberCount/@Model.Club.MaxMembers)</h6>
                    </div>
                    <div class="card-body">
                        @if (Model.Members.Any())
                        {
                            <div class="list-group list-group-flush">
                                @{
                                    var displayMembers = Model.IsMember ? Model.Members : Model.Members.Take(5);
                                }
                                @foreach (var member in displayMembers)
                                {
                                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <strong>@@@(member.User?.Username ?? $"User {member.UserId}")</strong>
                                            @if (member.UserId == Model.Club.OwnerId)
                                            {
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="bi bi-crown me-1"></i>Owner
                                                </span>
                                            }
                                            else if (member.Role == "Admin")
                                            {
                                                <span class="badge bg-danger ms-2">
                                                    <i class="bi bi-shield-fill-check me-1"></i>Admin
                                                </span>
                                            }
                                            else if (member.Role == "Moderator")
                                            {
                                                <span class="badge bg-info ms-2">
                                                    <i class="bi bi-star-fill me-1"></i>Moderator
                                                </span>
                                            }
                                            <br>
                                            <small class="text-muted">Joined @member.JoinedDate.ToString("MMM dd, yyyy")</small>
                                        </div>
                                        @if (Model.IsOwner && member.UserId != Model.Club.OwnerId)
                                        {
                                            <div>
                                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#changeRoleModal-@member.UserId"
                                                        title="Change Role">
                                                    <i class="bi bi-gear"></i>
                                                </button>
                                                <form method="post" asp-page-handler="RemoveMember" class="d-inline" onsubmit="return confirm('Remove this member?')">
                                                    <input type="hidden" name="clubId" value="@Model.Club.ClubId" />
                                                    <input type="hidden" name="memberUserId" value="@member.UserId" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                </form>
                                            </div>
                                            
                                            @* Change Role Modal for this member *@
                                            <div class="modal fade" id="changeRoleModal-@member.UserId" tabindex="-1">
                                                <div class="modal-dialog modal-sm">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h6 class="modal-title">Change Role</h6>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <form method="post" asp-page-handler="ChangeRole">
                                                            <div class="modal-body">
                                                                <input type="hidden" name="clubId" value="@Model.Club.ClubId" />
                                                                <input type="hidden" name="memberUserId" value="@member.UserId" />
                                                                <label class="form-label">Select Role</label>
                                                                <select name="newRole" class="form-select" required>
                                                                    <option value="Member" selected="@(member.Role == "Member")">Member</option>
                                                                    <option value="Moderator" selected="@(member.Role == "Moderator")">Moderator</option>
                                                                    <option value="Admin" selected="@(member.Role == "Admin")">Admin</option>
                                                                </select>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                            @if (!Model.IsMember && Model.Members.Count > 5)
                            {
                                <div class="text-center mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-lock me-1"></i>
                                        Join to see all @Model.MemberCount members
                                    </small>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">No members yet</p>
                        }
                    </div>
                </div>
                
                @if (!Model.IsMember)
                {
                    <div class="card shadow-sm mb-4 border-primary">
                        <div class="card-body text-center">
                            <i class="bi bi-info-circle text-primary fs-1 mb-3"></i>
                            <h5 class="card-title">About This Club</h5>
                            <ul class="list-unstyled text-start mt-3">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Connect with fellow readers
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Participate in discussions
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    Share your thoughts on books
                                </li>
                                @if (!string.IsNullOrEmpty(Model.Club.MeetingSchedule))
                                {
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Regular meetings: @Model.Club.MeetingSchedule
                                    </li>
                                }
                            </ul>
                            @if (Model.Club.MaxMembers > Model.MemberCount)
                            {
                                <form method="post" asp-page-handler="JoinClub" class="mt-3">
                                    <input type="hidden" name="clubId" value="@Model.Club.ClubId" />
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-plus-circle me-2"></i>Join Now
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                }

                @if (Model.CurrentBook != null)
                {
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-book-fill me-2"></i>Currently Reading
                            </h6>
                        </div>
                        <div class="card-body text-center">
                            <img src="@(string.IsNullOrEmpty(Model.CurrentBook.CoverUrl) ? "/images/no-cover.jpg" : Model.CurrentBook.CoverUrl)" 
                                 class="img-fluid rounded shadow-sm mb-3" 
                                 style="max-height: 250px; object-fit: cover;"
                                 alt="@Model.CurrentBook.Title">
                            <h6 class="mb-1">@Model.CurrentBook.Title</h6>
                            <p class="text-muted small mb-2">by @Model.CurrentBook.Author</p>
                            @if (Model.Club.CurrentBookStartDate.HasValue)
                            {
                                <small class="text-muted d-block">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    Started @Model.Club.CurrentBookStartDate.Value.ToString("MMM dd, yyyy")
                                </small>
                            }
                            @if (!Model.IsMember)
                            {
                                <div class="alert alert-info mt-3 mb-0">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        Join to discuss this book!
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (!Model.IsMember)
                {
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-book text-muted fs-2 mb-2"></i>
                            <p class="text-muted small mb-0">This club hasn't selected a book yet</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- New Discussion Modal -->
<div class="modal fade" id="newDiscussionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start a Discussion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="CreateDiscussion">
                <div class="modal-body">
                    <input type="hidden" name="clubId" value="@Model.Club?.ClubId" />
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea name="content" class="form-control" rows="5" required maxlength="1000"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Discussion</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Club Modal -->
@if (Model.IsOwner && Model.Club != null)
{
    <div class="modal fade" id="editClubModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>Edit Book Club
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" asp-page-handler="UpdateClub">
                    <div class="modal-body">
                        <input type="hidden" name="clubId" value="@Model.Club.ClubId" />
                        <div class="mb-3">
                            <label class="form-label">Club Name</label>
                            <input type="text" name="name" class="form-control" value="@Model.Club.Name" required maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="3" required maxlength="500">@Model.Club.Description</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Genre (Optional)</label>
                            <input type="text" name="genre" class="form-control" value="@Model.Club.Genre" maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Meeting Schedule (Optional)</label>
                            <input type="text" name="meetingSchedule" class="form-control" value="@Model.Club.MeetingSchedule" maxlength="200" placeholder="e.g., Every Tuesday at 7 PM">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Members</label>
                            <input type="number" name="maxMembers" class="form-control" value="@Model.Club.MaxMembers" min="1" max="500" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@* Set Current Book Modal *@
@if (Model.IsOwner)
{
    <div class="modal fade" id="setBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-book me-2"></i>Set Current Book
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Select a book for your club to read together:</p>
                    <form method="post" asp-page-handler="SetCurrentBook" id="setBookForm">
                        <input type="hidden" name="clubId" value="@(Model.Club?.ClubId ?? 0)" />
                        <div class="mb-3">
                            <label class="form-label">Choose a Book</label>
                            <select name="bookId" class="form-select" required>
                                <option value="">-- Select a book --</option>
                                @if (Model.CurrentBook != null && Model.Club != null)
                                {
                                    <option value="0">Clear current book</option>
                                }
                                @foreach (var book in Model.AllBooks)
                                {
                                    <option value="@book.BookId" selected="@(Model.CurrentBook?.BookId == book.BookId)">
                                        @book.Title by @book.Author
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check me-1"></i>Set Book
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @* Pending Members Modal *@
    <div class="modal fade" id="pendingMembersModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-people me-2"></i>Pending Member Requests
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    @if (Model.PendingMembers.Any())
                    {
                        <div class="list-group">
                            @foreach (var member in Model.PendingMembers)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-person-circle text-muted me-2"></i>
                                        <strong>@@@(member.User?.Username ?? $"User {member.UserId}")</strong>
                                        <br>
                                        <small class="text-muted">Requested @member.JoinedDate.ToString("MMM dd, yyyy")</small>
                                    </div>
                                    <div>
                                        <form method="post" asp-page-handler="ApproveMember" class="d-inline">
                                            <input type="hidden" name="clubId" value="@(Model.Club?.ClubId ?? 0)" />
                                            <input type="hidden" name="memberUserId" value="@member.UserId" />
                                            <button type="submit" class="btn btn-sm btn-success me-1">
                                                <i class="bi bi-check-circle"></i> Approve
                                            </button>
                                        </form>
                                        <form method="post" asp-page-handler="RemoveMember" class="d-inline">
                                            <input type="hidden" name="clubId" value="@(Model.Club?.ClubId ?? 0)" />
                                            <input type="hidden" name="memberUserId" value="@member.UserId" />
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-x-circle"></i> Reject
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center mb-0">No pending requests</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Club Modal *@
@if (Model.IsOwner)
{
    <div class="modal fade" id="deleteClubModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Delete Book Club
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" asp-page-handler="DeleteClub">
                    <div class="modal-body">
                        <input type="hidden" name="clubId" value="@(Model.Club?.ClubId ?? 0)" />
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> This action cannot be undone!
                        </div>
                        <p>Are you sure you want to delete <strong>@(Model.Club?.Name ?? "this club")</strong>?</p>
                        <p>This will permanently delete:</p>
                        <ul>
                            <li>All club information</li>
                            <li>All discussion posts and replies</li>
                            <li>All member records</li>
                        </ul>
                        <p class="text-muted">Type the club name to confirm:</p>
                        <input type="text" class="form-control" id="deleteConfirmInput" placeholder="@(Model.Club?.Name ?? "")" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="deleteConfirmBtn" disabled>
                            <i class="bi bi-trash me-1"></i>Delete Club
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script>
    // Enable delete button only when club name is correctly typed
    const deleteInput = document.getElementById('deleteConfirmInput');
    const deleteBtn = document.getElementById('deleteConfirmBtn');
    const clubName = '@Model.Club?.Name';
    
    if (deleteInput && deleteBtn) {
        deleteInput.addEventListener('input', function() {
            deleteBtn.disabled = this.value !== clubName;
        });
    }
</script>

@if (TempData["Message"] != null)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <strong class="me-auto">@(TempData["MessageType"]?.ToString() == "success" ? "Success" : "Error")</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                @TempData["Message"]
            </div>
        </div>
    </div>
}
